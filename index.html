<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Knee Angle Demo</title>
<style>
  body { margin:0; overflow:hidden; background:black; touch-action:none; }
  #video {
    position:absolute; top:0; left:0;
    width:100vw; height:100vh; object-fit:cover;
  }
  #canvas { position:absolute; top:0; left:0; }
  #label {
    position:absolute; top:10px; left:10px;
    background:rgba(0,0,0,0.5); color:white;
    padding:6px 10px; font-size:20px; border-radius:8px;
  }
  #controls {
    position:absolute; bottom:10px; left:10px;
    display:flex; gap:10px;
  }
  button {
    padding:8px 14px; font-size:16px; border-radius:8px;
    background:#222; color:white; border:1px solid #555;
  }
</style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>
<div id="label">Knee Angle: --°</div>

<div id="controls">
  <button id="flipBtn">Flip Camera</button>
  <button id="resetBtn">Reset</button>
  <button id="snapBtn">Snapshot</button>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const label = document.getElementById('label');
const flipBtn = document.getElementById('flipBtn');
const resetBtn = document.getElementById('resetBtn');
const snapBtn = document.getElementById('snapBtn');

let points = [];
let dragging = null;
let stream = null;
let videoInputs = [];
let currentCamIndex = 0;

// ========= CAMERA CONTROL =========
async function listCameras() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  videoInputs = devices.filter(d => d.kind === "videoinput");

  // prioritize back camera if labeled
  videoInputs.sort((a,b) =>
    b.label.toLowerCase().includes("back") - a.label.toLowerCase().includes("back")
  );
}

async function startCamera() {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
  }

  const deviceId = videoInputs[currentCamIndex]?.deviceId;

  stream = await navigator.mediaDevices.getUserMedia({
    video: { deviceId: { exact: deviceId } },
    audio: false
  });

  video.srcObject = stream;
}

flipBtn.onclick = () => {
  if (videoInputs.length > 1) {
    currentCamIndex = (currentCamIndex + 1) % videoInputs.length;
    startCamera();
  }
};

async function initCamera() {
  await listCameras();
  await startCamera();
}

initCamera();

// ========= CANVAS + ANGLE =========
function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener('resize', resize);

function calcAngle(A,B,C){
  const v1 = {x:A.x-B.x, y:A.y-B.y};
  const v2 = {x:C.x-B.x, y:C.y-B.y};
  const dot = v1.x*v2.x + v1.y*v2.y;
  const mag1 = Math.hypot(v1.x,v1.y);
  const mag2 = Math.hypot(v2.x,v2.y);
  const theta = Math.acos(dot/(mag1*mag2));
  return theta * 180/Math.PI;
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(points.length > 0){
    points.forEach(p=>{
      ctx.fillStyle="red";
      ctx.beginPath();
      ctx.arc(p.x,p.y,8,0,2*Math.PI);
      ctx.fill();
      ctx.fillStyle="white";
      ctx.font="18px sans-serif";
      ctx.fillText(p.label, p.x+10, p.y+5);
    });
  }

  if(points.length === 3){
    ctx.strokeStyle="yellow";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(points[0].x,points[0].y);
    ctx.lineTo(points[1].x,points[1].y);
    ctx.lineTo(points[2].x,points[2].y);
    ctx.stroke();

    const angle = calcAngle(points[0],points[1],points[2]);
    label.textContent = "Knee Angle: "+angle.toFixed(1)+"°";
  } else {
    label.textContent = "Knee Angle: --°";
  }

  requestAnimationFrame(draw);
}
draw();

// ========= TOUCH =========
function getTouchPos(e){
  const t = e.touches[0];
  return {x:t.clientX, y:t.clientY};
}

canvas.addEventListener('touchstart',e=>{
  const pos = getTouchPos(e);

  for(let p of points){
    if(Math.hypot(pos.x-p.x, pos.y-p.y) < 20){
      dragging = p;
      return;
    }
  }

  if(points.length<3){
    const labels=["A","B","C"];
    points.push({x:pos.x,y:pos.y,label:labels[points.length]});
  }
});

canvas.addEventListener('touchmove',e=>{
  if(dragging){
    const pos = getTouchPos(e);
    dragging.x = pos.x;
    dragging.y = pos.y;
  }
});

canvas.addEventListener('touchend',()=> dragging = null);

// RESET
resetBtn.onclick = ()=>{ points = []; };

// SNAPSHOT
snapBtn.onclick = ()=>{
  const sc=document.createElement('canvas');
  sc.width=canvas.width; sc.height=canvas.height;
  const sctx=sc.getContext('2d');
  sctx.drawImage(video,0,0,canvas.width,canvas.height);
  sctx.drawImage(canvas,0,0);
  const a=document.createElement('a');
  a.download="knee_angle.png";
  a.href=sc.toDataURL();
  a.click();
};
</script>
</body>
</html>
